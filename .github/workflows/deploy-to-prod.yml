name: Deploy to prod
on:
    workflow_dispatch:
    push:
        branches:
            - 'main'

jobs:
    guard-main-branch:
        name: Validate main branch
        runs-on: ubuntu-latest
        steps:
            - name: Abort if branch is not main
              run: |
                  if [ "${{ github.ref }}" != "refs/heads/main" ]; then
                      echo "This workflow can only run on the main branch. Current ref: ${{ github.ref }}"
                      exit 1
                  fi

    build:
        name: Build image
        needs: guard-main-branch
        permissions:
            contents: read
            id-token: write
        uses: ./.github/workflows/build-image.yml
        secrets:
            NAIS_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}

    deploy-prod-gcp:
        name: Deploy to prod-gcp
        permissions:
            contents: read
            id-token: write
        uses: ./.github/workflows/deploy-to-nais.yml
        needs: build
        with:
            image: ${{ needs.build.outputs.image }}
            cluster: prod-gcp
